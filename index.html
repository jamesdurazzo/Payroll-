<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>District 31 Payroll</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.4/jspdf.plugin.autotable.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap');
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  :root{--black:#1a1a1a;--dark:#333;--mid:#777;--light:#b0b0b0;--faint:#d8d8d8;--hairline:#e6e6e6;--wash:#f4f4f2;--white:#fafaf8;--paper:#fff;--accent:#c43e1c;--accent2:#1c6ec4;--mono:'IBM Plex Mono',monospace;--sans:'IBM Plex Sans',sans-serif}
  body{font-family:var(--sans);background:var(--wash);color:var(--black);min-height:100vh;-webkit-font-smoothing:antialiased;font-size:13px;line-height:1.4}
  ::selection{background:var(--black);color:var(--white)}
  input[type="number"]::-webkit-inner-spin-button,input[type="number"]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
  input[type="number"]{-moz-appearance:textfield}

  .topbar{background:#1a1a1a;height:48px;display:flex;align-items:center;justify-content:space-between;padding:0 20px;position:sticky;top:0;z-index:100}
  .topbar-left{display:flex;align-items:center;gap:16px}
  .topbar-mark{width:8px;height:8px;border-radius:50%;background:#c43e1c}
  .topbar-title{color:#ffffff;font-size:12px;font-weight:600;letter-spacing:.08em;text-transform:uppercase}
  .topbar-district{color:#999;font-size:10px;font-family:var(--mono);letter-spacing:.05em}
  .topbar-right{display:flex;align-items:center;gap:16px}
  .topbar-label{font-size:10px;color:#999;letter-spacing:.04em}
  .topbar-date{background:transparent;border:1px solid #555;border-radius:2px;color:#ddd;padding:4px 10px;font-size:11px;font-family:var(--mono);cursor:pointer;outline:none}
  .topbar-date:focus{border-color:#888}
  .topbar-date::-webkit-calendar-picker-indicator{filter:invert(1)}

  .school-tabs{display:flex;gap:0;margin-left:24px}
  .school-tab{background:transparent;border:none;border-top:none;border-left:none;border-right:none;color:#888;font-size:11px;font-family:var(--sans);font-weight:500;letter-spacing:.06em;text-transform:uppercase;padding:0 16px;cursor:pointer;transition:all .15s;border-bottom:3px solid transparent;height:48px;display:flex;align-items:center}
  .school-tab:hover{color:#ccc}
  .school-tab.active{color:#ffffff;border-bottom-color:#c43e1c}
  .school-tab.ps44-active{color:#ffffff;border-bottom-color:#1c6ec4}

  .export-wrap{position:relative}
  .export-btn{background:transparent;border:1px solid #555;color:#ddd;font-size:10px;font-family:var(--sans);letter-spacing:.06em;text-transform:uppercase;padding:5px 14px;cursor:pointer;transition:all .15s;border-radius:2px}
  .export-btn:hover{border-color:#888;color:#fff}
  .export-menu{position:absolute;top:36px;right:0;background:var(--paper);border:1px solid var(--faint);box-shadow:0 8px 32px rgba(0,0,0,.1);min-width:200px;display:none;z-index:200}
  .export-menu.open{display:block}
  .export-menu-item{display:block;width:100%;padding:10px 14px;border:none;background:transparent;text-align:left;font-size:12px;font-family:var(--sans);color:var(--dark);cursor:pointer;border-bottom:1px solid var(--hairline)}
  .export-menu-item:last-child{border-bottom:none}
  .export-menu-item:hover{background:var(--wash)}
  .export-menu-item .em-label{display:block;font-weight:500;color:var(--black)}
  .export-menu-item .em-desc{display:block;font-size:10px;color:var(--light);margin-top:2px}

  .layout{display:flex;min-height:calc(100vh - 48px)}
  .sidebar{width:200px;min-width:200px;background:var(--paper);border-right:1px solid var(--hairline);display:flex;flex-direction:column}
  .sidebar-nav{padding:16px 12px 12px}
  .nav-btn{width:100%;display:block;padding:6px 8px;border:none;border-radius:0;background:transparent;color:var(--mid);font-size:11px;font-weight:400;cursor:pointer;font-family:var(--sans);text-align:left;letter-spacing:.02em;transition:color .1s;margin-bottom:1px;border-left:2px solid transparent}
  .nav-btn:hover{color:var(--black)}
  .nav-btn.active{color:var(--black);font-weight:600;border-left-color:var(--accent);padding-left:6px}
  .sidebar.ps44 .nav-btn.active{border-left-color:var(--accent2)}
  .emp-list{flex:1;padding:8px 12px;overflow-y:auto;border-top:1px solid var(--hairline)}
  .emp-list-label{font-size:9px;font-weight:500;color:var(--light);letter-spacing:.12em;text-transform:uppercase;margin-bottom:8px;padding:0 8px}
  .emp-btn{width:100%;display:flex;align-items:center;gap:10px;padding:7px 8px;border:none;background:transparent;cursor:pointer;text-align:left;transition:background .1s}
  .emp-btn:hover{background:var(--wash)}
  .emp-btn.active{background:var(--wash)}
  .emp-idx{width:20px;font-size:10px;font-family:var(--mono);color:var(--light);text-align:right;flex-shrink:0}
  .emp-btn.active .emp-idx{color:var(--accent);font-weight:600}
  .sidebar.ps44 .emp-btn.active .emp-idx{color:var(--accent2)}
  .emp-info{flex:1;min-width:0}
  .emp-name-text{font-size:12px;font-weight:400;color:var(--dark);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .emp-btn.active .emp-name-text{font-weight:600;color:var(--black)}
  .emp-hrs{font-size:10px;color:var(--light);font-family:var(--mono)}
  .emp-btn.active .emp-hrs{color:var(--mid)}
  .main{flex:1;padding:24px 28px;overflow-x:auto}

  .emp-header{display:flex;align-items:baseline;justify-content:space-between;margin-bottom:20px;padding-bottom:12px;border-bottom:1px solid var(--black)}
  .emp-header-left{display:flex;align-items:baseline;gap:16px}
  .emp-header-name{font-size:20px;font-weight:300;color:var(--black);letter-spacing:-.01em}
  .emp-header-meta{font-size:11px;color:var(--mid);font-family:var(--mono)}
  .emp-header-total{text-align:right;display:flex;align-items:baseline;gap:6px}
  .emp-total-num{font-size:24px;font-weight:300;color:var(--black);font-family:var(--mono);letter-spacing:-.02em}
  .emp-total-unit{font-size:11px;color:var(--mid);font-weight:400}

  .table-wrap{overflow-x:auto}
  table{width:100%;border-collapse:collapse}
  .cat-row th{padding:0 0 4px;font-size:9px;font-weight:500;letter-spacing:.1em;text-transform:uppercase;color:var(--mid);text-align:center;border-bottom:1px solid var(--hairline);height:24px;vertical-align:bottom}
  .col-row th{padding:4px 0;font-size:10px;font-weight:600;font-family:var(--mono);text-align:center;color:var(--dark);border-bottom:1px solid var(--hairline);letter-spacing:.02em}
  .sub-row th{padding:3px 0;font-size:9px;font-weight:400;text-align:center;color:var(--light);border-bottom:2px solid var(--black);letter-spacing:.04em;font-family:var(--mono)}
  .sub-row .th-date{text-align:left;padding-left:0}
  .sub-row .th-day{width:32px}

  .code-dropdown{position:relative}
  .code-dropdown-btn{width:100%;height:22px;border:none;border-bottom:1px solid var(--faint);background:transparent;color:var(--light);font-size:9px;font-family:var(--mono);cursor:pointer;text-align:center;padding:0 4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;transition:all .1s;letter-spacing:.02em}
  .code-dropdown-btn.has-value{color:var(--dark);font-weight:500}
  .code-dropdown-btn:hover{border-bottom-color:var(--dark)}
  .code-dropdown-panel{position:absolute;top:26px;left:50%;transform:translateX(-50%);z-index:1000;width:260px;background:var(--paper);border:1px solid var(--faint);box-shadow:0 8px 32px rgba(0,0,0,.08);display:none}
  .code-dropdown-panel.open{display:block}
  .code-search-wrap{padding:6px;border-bottom:1px solid var(--hairline)}
  .code-search{width:100%;border:1px solid var(--hairline);padding:5px 8px;font-size:11px;outline:none;font-family:var(--sans);background:var(--wash)}
  .code-search:focus{border-color:var(--dark)}
  .code-list{max-height:200px;overflow-y:auto}
  .code-item{padding:5px 8px;font-size:10px;cursor:pointer;display:flex;gap:8px;align-items:center;border-bottom:1px solid var(--hairline)}
  .code-item:hover{background:var(--wash)}
  .code-item-code{font-family:var(--mono);font-weight:600;font-size:9px;color:var(--accent);min-width:40px}
  .code-item-desc{color:var(--dark)}
  .code-clear{color:var(--light);padding:5px 8px;font-size:10px;cursor:pointer;border-bottom:1px solid var(--hairline)}
  .code-clear:hover{background:var(--wash);color:var(--dark)}

  .data-row{border-bottom:1px solid var(--hairline)}
  .data-row:hover{background:rgba(0,0,0,.015)}
  .data-row.weekend{opacity:.35}
  .data-row .c-date{padding:0;font-family:var(--mono);font-size:11px;color:var(--dark);font-weight:400;white-space:nowrap;height:32px;vertical-align:middle}
  .data-row .c-day{padding:0 4px;text-align:center;font-size:10px;color:var(--light);font-family:var(--mono);vertical-align:middle}
  .data-row .c-input{padding:0 1px;vertical-align:middle}
  .cell-input{width:100%;height:32px;border:none;background:transparent;text-align:center;font-size:12px;font-family:var(--mono);font-weight:400;color:var(--light);outline:none;transition:all .1s;padding:0;border-bottom:1px solid transparent}
  .cell-input::placeholder{color:var(--faint)}
  .cell-input:focus{background:rgba(0,0,0,.02);border-bottom:1px solid var(--black);color:var(--black)}
  .cell-input.has-value{font-weight:500;color:var(--black)}
  .data-row .c-total{padding:0 6px;text-align:center;font-family:var(--mono);font-size:12px;vertical-align:middle}
  .c-total.has-val{font-weight:600;color:var(--black)}
  .c-total.no-val{color:var(--faint)}

  .totals-row{border-top:2px solid var(--black)}
  .totals-row td{padding:8px 0;text-align:center;font-family:var(--mono);font-weight:500;font-size:12px;color:var(--dark)}
  .totals-row .t-label{text-align:left;font-family:var(--sans);font-size:10px;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:var(--mid)}
  .totals-row .t-no-val{color:var(--faint)}
  .totals-row .t-grand{font-weight:600;color:var(--black);font-size:13px}

  .page-title{font-size:20px;font-weight:300;color:var(--black);margin-bottom:4px;letter-spacing:-.01em}
  .page-desc{font-size:12px;color:var(--mid);margin-bottom:20px}
  .search-input{width:100%;border:none;border-bottom:1px solid var(--faint);padding:8px 0;font-size:13px;margin-bottom:24px;outline:none;font-family:var(--sans);background:transparent;color:var(--black)}
  .search-input::placeholder{color:var(--light)}
  .search-input:focus{border-bottom-color:var(--black)}
  .codes-cat-label{font-size:9px;font-weight:500;color:var(--light);letter-spacing:.12em;text-transform:uppercase;margin-bottom:6px;margin-top:20px}
  .codes-cat-label:first-of-type{margin-top:0}
  .code-ref-item{display:flex;align-items:center;gap:12px;padding:5px 0;border-bottom:1px solid var(--hairline)}
  .code-ref-badge{font-family:var(--mono);font-size:10px;font-weight:600;color:var(--accent);min-width:48px}
  .code-ref-desc{font-size:12px;color:var(--dark)}
  .settings-card{padding:16px 0;border-bottom:1px solid var(--hairline)}
  .settings-label{display:block;font-size:9px;font-weight:500;color:var(--light);letter-spacing:.1em;text-transform:uppercase;margin-bottom:6px}
  .settings-input{border:none;border-bottom:1px solid var(--faint);padding:6px 0;font-size:14px;font-family:var(--mono);background:transparent;outline:none;color:var(--black);width:200px}
  .settings-input:focus{border-bottom-color:var(--black)}
  .settings-hint{font-size:11px;color:var(--light);margin-top:4px}
  .settings-static{font-size:14px;font-family:var(--mono);color:var(--dark);padding:6px 0}
  .settings-instructions{font-size:12px;color:var(--mid);line-height:1.8}
</style>
</head>
<body>
<div class="topbar">
  <div class="topbar-left">
    <div class="topbar-mark" id="topbarMark"></div>
    <span class="topbar-title" id="topbarTitle">Port Richmond Payroll</span>
    <span class="topbar-district">Dist. 31</span>
    <div class="school-tabs" id="schoolTabs">
      <button class="school-tab active" data-school="portrichmond">Port Richmond</button>
      <button class="school-tab" data-school="ps44">PS 44</button>
    </div>
  </div>
  <div class="topbar-right">
    <span class="topbar-label">Period ending</span>
    <input type="date" class="topbar-date" id="payPeriodEnd" value="2026-01-27">
    <div class="export-wrap">
      <button class="export-btn" id="exportBtn">Export PDF</button>
      <div class="export-menu" id="exportMenu">
        <button class="export-menu-item" id="exportCurrent">
          <span class="em-label">Current Employee</span>
          <span class="em-desc">Export selected timesheet only</span>
        </button>
        <button class="export-menu-item" id="exportAll">
          <span class="em-label">All Employees</span>
          <span class="em-desc">Export all timesheets for current school</span>
        </button>
      </div>
    </div>
  </div>
</div>
<div class="layout">
  <div class="sidebar" id="sidebarEl">
    <div class="sidebar-nav" id="sidebarNav"></div>
    <div class="emp-list" id="empList"></div>
  </div>
  <div class="main" id="mainContent"></div>
</div>
<script>
var CODES=[
  {c:"I2JI3",d:"Overtime Lunch - SLH"},{c:"I2JI4",d:"Overtime Lunch - Sr. SLH"},{c:"I2JI5",d:"Special Event - SLH"},
  {c:"I2JI6",d:"Special Event - Sr. SLH"},{c:"I2JI7",d:"Weekend OT - SLH"},{c:"I2JI8",d:"Weekend OT - Sr. SLH"},
  {c:"I2JI9",d:"Holiday OT - SLH"},{c:"I2JIA",d:"Holiday OT - Sr. SLH"},{c:"I2JIB",d:"Snack - SLH"},
  {c:"I2JIC",d:"Snack - Sr. SLH"},{c:"I2JID",d:"Supper - SLH"},{c:"I2JIE",d:"Supper - Sr. SLH"},
  {c:"I2JIF",d:"School Aide Breakfast Hrs"},{c:"I2JIG",d:"BIC - SLH"},{c:"I2JIH",d:"BIC - Sr. SLH"},
  {c:"600FL",d:"Family Leave All"},{c:"60A00",d:"Court Subpoena"},{c:"60B00",d:"Death in Family"},
  {c:"60B0T",d:"Death in Family Travel"},{c:"60B10",d:"Funeral Relative"},{c:"60B20",d:"Funeral Coworker"},
  {c:"60C00",d:"Graduation"},{c:"60C0T",d:"Graduation / Travel"},
  {c:"61A00",d:"Self Treated Lunch"},{c:"61AAF",d:"Self Treated Afterschool"},{c:"61ABR",d:"Self Treated Breakfast"},
  {c:"61B00",d:"Medical Lunch"},{c:"61B0F",d:"Family Leave Lunch"},{c:"61BAF",d:"Medical Afterschool"},
  {c:"61BAT",d:"Family Leave Afterschool"},{c:"61BBF",d:"Family Leave Breakfast"},{c:"61BBR",d:"Medical Breakfast"},
  {c:"61BWC",d:"Workers Comp Med Cert"},{c:"61HFL",d:"Holiday Float 4 Days"},
  {c:"62RAF",d:"Religious Afterschool"},{c:"62RBR",d:"Religious Breakfast"},{c:"62RLG",d:"Religious Lunch"},
  {c:"63A00",d:"Personal Day Lunch"},{c:"63AAF",d:"Personal Day Afterschool"},{c:"63ABR",d:"Personal Day Breakfast"},
  {c:"63ECS",d:"Cancer Screening"},{c:"64A00",d:"Jury Duty"},
  {c:"66B00",d:"Workers Comp Injury"},{c:"66BH0",d:"Workers Comp Hearing"},
  {c:"67A00",d:"Lateness"},{c:"68A00",d:"Transit Delay"}
];
var SC=[{k:"pyreg",l:"PYREG"},{k:"pybrk",l:"PYBRK"},{k:"pyaft",l:"PYAFT"}];
var BC=[{k:"bulk1",l:"--"},{k:"bulk2",l:"--"},{k:"bulk3",l:"--"},{k:"bulk4",l:"--"}];
var AC = SC.concat(BC);

var SCHOOLS = {
  portrichmond: {
    name: "Port Richmond Payroll",
    code: "Port Richmond",
    accent: "#c43e1c",
    emps: [
      {id:1,f:"Lahene",l:"Edwards",eis:"2245250"},
      {id:2,f:"Servette",l:"Liharevic",eis:"2715560"},
      {id:3,f:"Seham",l:"Said",eis:"2712067"},
      {id:4,f:"Akil",l:"Ibtissam",eis:"2730676"},
      {id:5,f:"Angelina",l:"Obermeyer",eis:"2723767"},
      {id:6,f:"Nancy",l:"Wesa",eis:"2744757"},
      {id:7,f:"Carlo",l:"Fleming",eis:"TBD"}
    ]
  },
  ps44: {
    name: "PS 44 Payroll",
    code: "PS 44",
    accent: "#1c6ec4",
    emps: [
      {id:101,f:"Pietra",l:"Vendra",eis:"2736062"},
      {id:102,f:"Michael",l:"Legair",eis:"2744810"},
      {id:103,f:"Cristina",l:"Picciurro",eis:"2727735"}
    ]
  }
};

var S = {
  payEnd: "2026-01-27",
  sel: 0,
  view: "timesheet",
  data: {},
  bc: {},
  school: "portrichmond"
};

// Pre-fill Lahene Edwards data
var prefillDates = ["2026-01-14","2026-01-15","2026-01-16","2026-01-19","2026-01-20","2026-01-21","2026-01-22","2026-01-23","2026-01-26","2026-01-27"];
for (var pi = 0; pi < prefillDates.length; pi++) {
  S.data["1_" + prefillDates[pi] + "_pyreg_hrs"] = 7;
}

function curSchool() { return SCHOOLS[S.school]; }
function curEmps() { return curSchool().emps; }

function mkDates(e) {
  var end = new Date(e + "T12:00:00");
  var r = [];
  for (var i = 13; i >= 0; i--) {
    var d = new Date(end);
    d.setDate(d.getDate() - i);
    r.push(d);
  }
  return r;
}

function fmt(d) {
  return String(d.getMonth() + 1).padStart(2, "0") + "/" + String(d.getDate()).padStart(2, "0") + "/" + d.getFullYear();
}

function dn(d) {
  return d.toLocaleDateString("en-US", { weekday: "short" });
}

function dk(d) {
  return d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, "0") + "-" + String(d.getDate()).padStart(2, "0");
}

function gv(eid, k, col, f) {
  return S.data[eid + "_" + k + "_" + col + "_" + f] || 0;
}

function sv(eid, k, col, f, v) {
  var key = eid + "_" + k + "_" + col + "_" + f;
  if (!v || isNaN(v)) { delete S.data[key]; } else { S.data[key] = v; }
  render();
}

function etot(emp) {
  var d = mkDates(S.payEnd);
  var h = 0, m = 0;
  for (var di = 0; di < d.length; di++) {
    var k = dk(d[di]);
    for (var ci = 0; ci < AC.length; ci++) {
      h += gv(emp.id, k, AC[ci].k, "hrs");
      m += gv(emp.id, k, AC[ci].k, "min");
    }
  }
  return { h: h + Math.floor(m / 60), m: m % 60 };
}

function ccat(code) {
  if (code.indexOf("I2J") === 0) return "Overtime / Special";
  if (code.indexOf("60") === 0) return "Leave & Events";
  if (code.indexOf("61") === 0) return "Medical";
  if (code.indexOf("62") === 0) return "Religious";
  if (code.indexOf("63") === 0) return "Personal";
  return "Administrative";
}

// PDF
function buildEmpPdfData(emp) {
  var d = mkDates(S.payEnd);
  var bulkLabels = [];
  for (var bi = 0; bi < BC.length; bi++) { bulkLabels.push(S.bc[emp.id + "_" + bi] || "--"); }
  var colLabels = [];
  for (var si = 0; si < SC.length; si++) { colLabels.push(SC[si].l); }
  for (var bi2 = 0; bi2 < bulkLabels.length; bi2++) { colLabels.push(bulkLabels[bi2]); }
  var headRow = ["Date", "Day"];
  for (var ci = 0; ci < colLabels.length; ci++) { headRow.push(colLabels[ci] + " H"); headRow.push(colLabels[ci] + " M"); }
  headRow.push("Total H"); headRow.push("Total M");
  var head = [headRow];
  var body = [];
  for (var di = 0; di < d.length; di++) {
    var k = dk(d[di]);
    var row = [fmt(d[di]), dn(d[di])];
    var rh = 0, rm = 0;
    for (var ci2 = 0; ci2 < AC.length; ci2++) {
      var hv = gv(emp.id, k, AC[ci2].k, "hrs");
      var mv = gv(emp.id, k, AC[ci2].k, "min");
      rh += hv; rm += mv;
      row.push(hv || ""); row.push(mv || "");
    }
    var nh = rh + Math.floor(rm / 60), nm = rm % 60;
    row.push(nh || ""); row.push(nm || "");
    body.push(row);
  }
  var totRow = ["TOTALS", ""];
  for (var ci3 = 0; ci3 < AC.length; ci3++) {
    var ch = 0, cm = 0;
    for (var di2 = 0; di2 < d.length; di2++) { ch += gv(emp.id, dk(d[di2]), AC[ci3].k, "hrs"); cm += gv(emp.id, dk(d[di2]), AC[ci3].k, "min"); }
    totRow.push(ch || ""); totRow.push(cm || "");
  }
  var t = etot(emp);
  totRow.push(t.h); totRow.push(t.m || "");
  body.push(totRow);
  return { head: head, body: body, emp: emp, total: t };
}

function exportPdf(empIndices) {
  var jsPDF = window.jspdf.jsPDF;
  var doc = new jsPDF({ orientation: "landscape", unit: "pt", format: "letter" });
  var pageW = doc.internal.pageSize.getWidth();
  var emps = curEmps();
  var schoolName = curSchool().name.toUpperCase() + " - DISTRICT 31";
  for (var pi = 0; pi < empIndices.length; pi++) {
    if (pi > 0) doc.addPage("letter", "landscape");
    var emp = emps[empIndices[pi]];
    var result = buildEmpPdfData(emp);
    var head = result.head, body = result.body, total = result.total;
    var margin = 40, y = margin;
    doc.setFont("helvetica", "normal"); doc.setFontSize(7); doc.setTextColor(180);
    doc.text(schoolName, margin, y);
    doc.text("PAY PERIOD ENDING: " + fmt(mkDates(S.payEnd)[13]), pageW - margin, y, { align: "right" });
    y += 18;
    doc.setFontSize(14); doc.setTextColor(26);
    doc.text(emp.f + " " + emp.l, margin, y);
    var totalStr = total.h + (total.m > 0 ? ":" + String(total.m).padStart(2, "0") : "") + " hours";
    doc.text(totalStr, pageW - margin, y, { align: "right" });
    y += 6; doc.setFontSize(8); doc.setTextColor(120); doc.setFont("courier", "normal");
    doc.text("EIS " + emp.eis, margin, y + 10);
    y += 8; doc.setDrawColor(26); doc.setLineWidth(0.5);
    doc.line(margin, y + 6, pageW - margin, y + 6); y += 14;
    var closureBody = body;
    var closurePi = pi;
    var closureLen = empIndices.length;
    doc.autoTable({
      startY: y, head: head, body: body,
      margin: { left: margin, right: margin },
      styles: { font: "courier", fontSize: 6.5, cellPadding: { top: 3, bottom: 3, left: 3, right: 3 }, textColor: [51,51,51], lineColor: [230,230,230], lineWidth: 0.25, halign: "center", valign: "middle" },
      headStyles: { fillColor: [244,244,242], textColor: [26,26,26], fontStyle: "bold", fontSize: 5.5, halign: "center" },
      columnStyles: { 0: { halign: "left", cellWidth: 58 }, 1: { halign: "center", cellWidth: 28 } },
      bodyStyles: { minCellHeight: 14 },
      didParseCell: function(data) {
        if (data.row.index === closureBody.length - 1) { data.cell.styles.fontStyle = "bold"; data.cell.styles.fillColor = [244,244,242]; data.cell.styles.textColor = [26,26,26]; }
        var rd = closureBody[data.row.index];
        if (rd && (rd[1] === "Sat" || rd[1] === "Sun") && data.row.index < closureBody.length - 1) { data.cell.styles.textColor = [200,200,200]; }
        if (data.cell.raw === "" && data.section === "body") { data.cell.styles.textColor = [220,220,220]; }
      },
      didDrawPage: function(data) {
        doc.setFont("helvetica", "normal"); doc.setFontSize(6); doc.setTextColor(180);
        var pageH = doc.internal.pageSize.getHeight();
        doc.text("Generated " + new Date().toLocaleDateString("en-US", { month: "long", day: "numeric", year: "numeric" }), margin, pageH - 24);
        doc.text("Page " + (closurePi + 1) + " of " + closureLen, pageW - margin, pageH - 24, { align: "right" });
      }
    });
  }
  var dateStr = S.payEnd.replace(/-/g, "");
  var label = empIndices.length === 1 ? emps[empIndices[0]].l + "_" + emps[empIndices[0]].f : "All_Employees";
  var schoolPrefix = S.school === "ps44" ? "PS44" : "PortRichmond";
  doc.save(schoolPrefix + "_Payroll_" + label + "_" + dateStr + ".pdf");
}

document.getElementById("exportBtn").addEventListener("click", function(e) {
  e.stopPropagation();
  document.getElementById("exportMenu").classList.toggle("open");
});
document.getElementById("exportCurrent").addEventListener("click", function() {
  document.getElementById("exportMenu").classList.remove("open");
  exportPdf([S.sel]);
});
document.getElementById("exportAll").addEventListener("click", function() {
  document.getElementById("exportMenu").classList.remove("open");
  var indices = [];
  for (var i = 0; i < curEmps().length; i++) indices.push(i);
  exportPdf(indices);
});
document.addEventListener("click", function(e) {
  if (!e.target.closest(".export-wrap")) document.getElementById("exportMenu").classList.remove("open");
});

// School tabs
document.getElementById("schoolTabs").addEventListener("click", function(e) {
  var tab = e.target.closest(".school-tab");
  if (!tab) return;
  S.school = tab.getAttribute("data-school");
  S.sel = 0;
  S.view = "timesheet";
  render();
});

// RENDER
function render() {
  var school = curSchool();
  var emps = curEmps();

  document.getElementById("topbarTitle").textContent = school.name;
  document.getElementById("topbarMark").style.background = school.accent;

  // School tabs
  var tabs = document.querySelectorAll(".school-tab");
  for (var ti = 0; ti < tabs.length; ti++) {
    tabs[ti].className = "school-tab";
    if (tabs[ti].getAttribute("data-school") === S.school) {
      tabs[ti].className = "school-tab active";
      if (S.school === "ps44") tabs[ti].className = "school-tab active ps44-active";
    }
  }

  // Sidebar class
  document.getElementById("sidebarEl").className = S.school === "ps44" ? "sidebar ps44" : "sidebar";

  // Nav buttons
  var navHtml = '<button class="nav-btn ' + (S.view === "timesheet" ? "active" : "") + '" data-view="timesheet">Timesheets</button>';
  navHtml += '<button class="nav-btn ' + (S.view === "codes" ? "active" : "") + '" data-view="codes">Codes Reference</button>';
  navHtml += '<button class="nav-btn ' + (S.view === "settings" ? "active" : "") + '" data-view="settings">Settings</button>';
  document.getElementById("sidebarNav").innerHTML = navHtml;

  document.getElementById("empList").style.display = S.view === "timesheet" ? "block" : "none";
  document.getElementById("payPeriodEnd").value = S.payEnd;

  // Employee list
  var el = document.getElementById("empList");
  var h = '<div class="emp-list-label">Employees</div>';
  for (var i = 0; i < emps.length; i++) {
    var t = etot(emps[i]);
    var hrs = t.h > 0 ? t.h + "h" + (t.m > 0 ? " " + t.m + "m" : "") : "--";
    h += '<button class="emp-btn ' + (S.sel === i ? "active" : "") + '" data-idx="' + i + '">';
    h += '<span class="emp-idx">' + String(i + 1).padStart(2, "0") + '</span>';
    h += '<div class="emp-info"><div class="emp-name-text">' + emps[i].l + ', ' + emps[i].f + '</div>';
    h += '<div class="emp-hrs">' + hrs + '</div></div></button>';
  }
  el.innerHTML = h;

  var mc = document.getElementById("mainContent");
  if (S.view === "timesheet") mc.innerHTML = rTS();
  else if (S.view === "codes") mc.innerHTML = rCodes();
  else mc.innerHTML = rSettings();

  bindEvents();
}

function rTS() {
  var emps = curEmps();
  var emp = emps[S.sel];
  var d = mkDates(S.payEnd);
  var t = etot(emp);
  var tStr = t.h + (t.m > 0 ? ":" + String(t.m).padStart(2, "0") : "");
  var schoolLabel = curSchool().code;
  var h = '';
  h += '<div class="emp-header"><div class="emp-header-left">';
  h += '<span class="emp-header-name">' + emp.f + ' ' + emp.l + '</span>';
  h += '<span class="emp-header-meta">EIS ' + emp.eis + ' &middot; ' + schoolLabel + ' &middot; Dist. 31</span>';
  h += '</div><div class="emp-header-total">';
  h += '<span class="emp-total-num">' + tStr + '</span><span class="emp-total-unit">hours</span>';
  h += '</div></div><div class="table-wrap"><table>';
  h += '<tr class="cat-row"><th colspan="2"></th><th colspan="' + (SC.length * 2) + '">Scheduled</th>';
  h += '<th colspan="' + (BC.length * 2) + '">Unscheduled / Bulk</th><th colspan="2"></th></tr>';
  h += '<tr class="col-row"><th colspan="2"></th>';
  for (var si = 0; si < SC.length; si++) { h += '<th colspan="2">' + SC[si].l + '</th>'; }
  for (var bi = 0; bi < BC.length; bi++) {
    var val = S.bc[emp.id + "_" + bi] || "";
    h += '<th colspan="2" style="padding:2px 4px"><div class="code-dropdown" data-emp="' + emp.id + '" data-bidx="' + bi + '">';
    h += '<button class="code-dropdown-btn ' + (val ? "has-value" : "") + '">' + (val || "Code") + '</button>';
    h += '<div class="code-dropdown-panel" id="cdp_' + emp.id + '_' + bi + '"><div class="code-search-wrap">';
    h += '<input class="code-search" placeholder="Search..." data-emp="' + emp.id + '" data-bidx="' + bi + '"></div>';
    h += '<div class="code-list" id="cdl_' + emp.id + '_' + bi + '"></div></div></div></th>';
  }
  h += '<th colspan="2">Total</th></tr>';
  h += '<tr class="sub-row"><th class="th-date">Date</th><th class="th-day">Day</th>';
  for (var ci = 0; ci < AC.length; ci++) { h += '<th>H</th><th>M</th>'; }
  h += '<th>H</th><th>M</th></tr>';
  for (var di = 0; di < d.length; di++) {
    var k = dk(d[di]), day = dn(d[di]), wk = d[di].getDay() === 0 || d[di].getDay() === 6;
    var rh = 0, rm = 0;
    for (var ci2 = 0; ci2 < AC.length; ci2++) { rh += gv(emp.id, k, AC[ci2].k, "hrs"); rm += gv(emp.id, k, AC[ci2].k, "min"); }
    var nh = rh + Math.floor(rm / 60), nm = rm % 60;
    h += '<tr class="data-row ' + (wk ? "weekend" : "") + '"><td class="c-date">' + fmt(d[di]) + '</td><td class="c-day">' + day + '</td>';
    for (var ci3 = 0; ci3 < AC.length; ci3++) {
      var hv = gv(emp.id, k, AC[ci3].k, "hrs"), mv = gv(emp.id, k, AC[ci3].k, "min");
      h += '<td class="c-input"><input class="cell-input ' + (hv ? "has-value" : "") + '" type="number" min="0" max="24" placeholder="&middot;" value="' + (hv || "") + '" data-emp="' + emp.id + '" data-dk="' + k + '" data-col="' + AC[ci3].k + '" data-field="hrs"></td>';
      h += '<td class="c-input"><input class="cell-input ' + (mv ? "has-value" : "") + '" type="number" min="0" max="59" placeholder="&middot;" value="' + (mv || "") + '" data-emp="' + emp.id + '" data-dk="' + k + '" data-col="' + AC[ci3].k + '" data-field="min"></td>';
    }
    h += '<td class="c-total ' + (nh ? "has-val" : "no-val") + '">' + (nh || "&middot;") + '</td>';
    h += '<td class="c-total ' + (nm ? "has-val" : "no-val") + '">' + (nm || "&middot;") + '</td></tr>';
  }
  h += '<tr class="totals-row"><td class="t-label" colspan="2">Totals</td>';
  for (var ci4 = 0; ci4 < AC.length; ci4++) {
    var ch = 0, cm = 0;
    for (var di2 = 0; di2 < d.length; di2++) { ch += gv(emp.id, dk(d[di2]), AC[ci4].k, "hrs"); cm += gv(emp.id, dk(d[di2]), AC[ci4].k, "min"); }
    h += '<td>' + (ch || "&middot;") + '</td><td class="' + (cm ? "" : "t-no-val") + '">' + (cm || "&middot;") + '</td>';
  }
  h += '<td class="t-grand">' + t.h + '</td><td class="' + (t.m ? "t-grand" : "t-no-val") + '">' + (t.m || "&middot;") + '</td></tr></table></div>';
  return h;
}

function rCodes() {
  var cats = {};
  for (var i = 0; i < CODES.length; i++) {
    var cat = ccat(CODES[i].c);
    if (!cats[cat]) cats[cat] = [];
    cats[cat].push(CODES[i]);
  }
  var h = '<div style="max-width:540px"><div class="page-title">Codes Reference</div>';
  h += '<div class="page-desc">Payroll codes for bulk entry, overtime, leave, and administrative use.</div>';
  h += '<input class="search-input" id="codeSearchInput" type="text" placeholder="Search...">';
  var catKeys = Object.keys(cats);
  for (var ci = 0; ci < catKeys.length; ci++) {
    h += '<div class="codes-cat-label" data-cat="' + catKeys[ci] + '">' + catKeys[ci] + '</div>';
    for (var j = 0; j < cats[catKeys[ci]].length; j++) {
      var c = cats[catKeys[ci]][j];
      h += '<div class="code-ref-item" data-code="' + c.c + '" data-desc="' + c.d + '">';
      h += '<span class="code-ref-badge">' + c.c + '</span><span class="code-ref-desc">' + c.d + '</span></div>';
    }
  }
  return h + '</div>';
}

function rSettings() {
  var h = '<div style="max-width:400px"><div class="page-title">Settings</div>';
  h += '<div class="page-desc">Pay period and district configuration.</div>';
  h += '<div class="settings-card"><label class="settings-label">Pay Period Ending</label>';
  h += '<input class="settings-input" type="date" id="settingsPayEnd" value="' + S.payEnd + '">';
  h += '<div class="settings-hint">All timesheets auto-update with 14 days ending on this date.</div></div>';
  h += '<div class="settings-card"><label class="settings-label">Current School</label>';
  h += '<div class="settings-static">' + curSchool().name + '</div></div>';
  h += '<div class="settings-card"><label class="settings-label">District</label><div class="settings-static">31</div></div>';
  h += '<div class="settings-card"><label class="settings-label">Instructions</label><div class="settings-instructions">';
  h += '1. Select a school tab at the top.<br>2. Set the pay period ending date.<br>';
  h += '3. Select an employee from the sidebar.<br>4. Enter hours and minutes in the grid.<br>';
  h += '5. Use code dropdowns for bulk/unscheduled entries.<br>6. Totals calculate automatically.</div></div></div>';
  return h;
}

function bindEvents() {
  var inputs = document.querySelectorAll(".cell-input");
  for (var i = 0; i < inputs.length; i++) {
    inputs[i].addEventListener("change", function(e) {
      var d = e.target.getAttribute("data-emp");
      var dk2 = e.target.getAttribute("data-dk");
      var col = e.target.getAttribute("data-col");
      var field = e.target.getAttribute("data-field");
      var val = e.target.value === "" ? null : parseInt(e.target.value, 10);
      sv(parseInt(d, 10), dk2, col, field, val);
    });
  }

  var cdBtns = document.querySelectorAll(".code-dropdown-btn");
  for (var j = 0; j < cdBtns.length; j++) {
    cdBtns[j].addEventListener("click", function(e) {
      var w = e.target.closest(".code-dropdown");
      var eid = w.getAttribute("data-emp");
      var bi = w.getAttribute("data-bidx");
      var p = document.getElementById("cdp_" + eid + "_" + bi);
      var panels = document.querySelectorAll(".code-dropdown-panel");
      for (var k = 0; k < panels.length; k++) { if (panels[k] !== p) panels[k].classList.remove("open"); }
      p.classList.toggle("open");
      if (p.classList.contains("open")) {
        var si = p.querySelector(".code-search");
        si.value = "";
        si.focus();
        fillCL(eid, bi, "");
      }
    });
  }

  var csInputs = document.querySelectorAll(".code-search");
  for (var k = 0; k < csInputs.length; k++) {
    csInputs[k].addEventListener("input", function(e) {
      fillCL(e.target.getAttribute("data-emp"), e.target.getAttribute("data-bidx"), e.target.value);
    });
  }

  var sd = document.getElementById("settingsPayEnd");
  if (sd) sd.addEventListener("change", function(e) { S.payEnd = e.target.value; render(); });

  var cs = document.getElementById("codeSearchInput");
  if (cs) {
    cs.addEventListener("input", function(e) {
      var q = e.target.value.toLowerCase();
      var items = document.querySelectorAll(".code-ref-item");
      for (var m = 0; m < items.length; m++) {
        var show = items[m].getAttribute("data-code").toLowerCase().indexOf(q) >= 0 || items[m].getAttribute("data-desc").toLowerCase().indexOf(q) >= 0;
        items[m].style.display = show ? "flex" : "none";
      }
      var labels = document.querySelectorAll(".codes-cat-label");
      for (var n = 0; n < labels.length; n++) {
        var nx = labels[n].nextElementSibling, any = false;
        while (nx && !nx.classList.contains("codes-cat-label")) {
          if (nx.style.display !== "none") any = true;
          nx = nx.nextElementSibling;
        }
        labels[n].style.display = any ? "block" : "none";
      }
    });
  }

  // Nav buttons
  var navBtns = document.querySelectorAll(".nav-btn");
  for (var nb = 0; nb < navBtns.length; nb++) {
    navBtns[nb].addEventListener("click", function(e) {
      S.view = e.target.getAttribute("data-view");
      render();
    });
  }

  // Employee buttons
  var empBtns = document.querySelectorAll(".emp-btn");
  for (var eb = 0; eb < empBtns.length; eb++) {
    empBtns[eb].addEventListener("click", function(e) {
      var btn = e.target.closest(".emp-btn");
      S.sel = parseInt(btn.getAttribute("data-idx"), 10);
      render();
    });
  }
}

function fillCL(eid, bi, search) {
  var el = document.getElementById("cdl_" + eid + "_" + bi);
  var q = search.toLowerCase();
  var filt = [];
  for (var i = 0; i < CODES.length; i++) {
    if (CODES[i].c.toLowerCase().indexOf(q) >= 0 || CODES[i].d.toLowerCase().indexOf(q) >= 0) filt.push(CODES[i]);
  }
  var h = '<div class="code-clear" data-emp="' + eid + '" data-bidx="' + bi + '" data-code="">Clear</div>';
  for (var j = 0; j < filt.length; j++) {
    h += '<div class="code-item" data-emp="' + eid + '" data-bidx="' + bi + '" data-code="' + filt[j].c + '">';
    h += '<span class="code-item-code">' + filt[j].c + '</span><span class="code-item-desc">' + filt[j].d + '</span></div>';
  }
  el.innerHTML = h;
  var items = el.querySelectorAll(".code-item,.code-clear");
  for (var k = 0; k < items.length; k++) {
    items[k].addEventListener("click", function(e) {
      var t = e.target.closest("[data-code]");
      S.bc[t.getAttribute("data-emp") + "_" + t.getAttribute("data-bidx")] = t.getAttribute("data-code");
      var panels = document.querySelectorAll(".code-dropdown-panel");
      for (var p = 0; p < panels.length; p++) panels[p].classList.remove("open");
      render();
    });
  }
}

document.addEventListener("click", function(e) {
  if (!e.target.closest(".code-dropdown")) {
    var panels = document.querySelectorAll(".code-dropdown-panel");
    for (var i = 0; i < panels.length; i++) panels[i].classList.remove("open");
  }
});

document.getElementById("payPeriodEnd").addEventListener("change", function(e) {
  S.payEnd = e.target.value;
  render();
});

render();
</script>
</body>
</html>
