<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Payroll Application</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.4/jspdf.plugin.autotable.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  :root {
    --bg: #f5f5f7;
    --card: #ffffff;
    --border: #e5e5e7;
    --text: #1d1d1f;
    --text2: #424245;
    --text3: #6e6e73;
    --text4: #aeaeb2;
    --accent: #d63c2f;
    --accent2: #0071e3;
    --mono: 'SF Mono', SFMono-Regular, Menlo, monospace;
    --sans: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', sans-serif;
    --radius: 12px;
    --shadow: 0 1px 3px rgba(0,0,0,.06), 0 1px 2px rgba(0,0,0,.04);
    --shadow2: 0 4px 16px rgba(0,0,0,.08);
  }
  body { font-family: var(--sans); background: var(--bg); color: var(--text); min-height: 100vh; -webkit-font-smoothing: antialiased; font-size: 14px; line-height: 1.5 }
  ::selection { background: var(--accent2); color: #fff }
  input[type="number"]::-webkit-inner-spin-button,input[type="number"]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
  input[type="number"]{-moz-appearance:textfield}
  .topbar{background:rgba(29,29,31,.97);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);height:52px;display:flex;align-items:center;justify-content:space-between;padding:0 24px;position:sticky;top:0;z-index:100}
  .topbar-left{display:flex;align-items:center;gap:20px}
  .topbar-mark{width:9px;height:9px;border-radius:50%;background:var(--accent)}
  .topbar-title{color:#f5f5f7;font-size:14px;font-weight:600;letter-spacing:-.01em}
  .topbar-district{color:#86868b;font-size:12px}
  .school-tabs{display:flex;gap:4px;margin-left:20px}
  .school-tab{background:transparent;border:none;color:#86868b;font-size:13px;font-family:var(--sans);font-weight:500;padding:6px 16px;cursor:pointer;transition:all .2s;border-radius:8px;height:34px;display:flex;align-items:center}
  .school-tab:hover{color:#d2d2d7;background:rgba(255,255,255,.08)}
  .school-tab.active{color:#fff;background:rgba(255,255,255,.12)}
  .school-tab.ps44-active{color:#fff;background:rgba(0,113,227,.3)}
  .topbar-right{display:flex;align-items:center;gap:14px}
  .topbar-label{font-size:12px;color:#86868b}
  .topbar-date{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);border-radius:8px;color:#e5e5e7;padding:5px 12px;font-size:13px;font-family:var(--sans);cursor:pointer;outline:none}
  .topbar-date:focus{border-color:var(--accent2)}
  .topbar-date::-webkit-calendar-picker-indicator{filter:invert(1)}
  .export-wrap{position:relative}
  .export-btn{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);color:#e5e5e7;font-size:13px;font-family:var(--sans);font-weight:500;padding:6px 16px;cursor:pointer;transition:all .2s;border-radius:8px}
  .export-btn:hover{background:rgba(255,255,255,.15);color:#fff}
  .export-menu{position:absolute;top:42px;right:0;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow2);min-width:220px;display:none;z-index:200;overflow:hidden}
  .export-menu.open{display:block}
  .export-menu-item{display:block;width:100%;padding:12px 16px;border:none;background:transparent;text-align:left;font-size:14px;font-family:var(--sans);color:var(--text);cursor:pointer;border-bottom:1px solid var(--border)}
  .export-menu-item:last-child{border-bottom:none}
  .export-menu-item:hover{background:var(--bg)}
  .export-menu-item .em-label{display:block;font-weight:600;color:var(--text)}
  .export-menu-item .em-desc{display:block;font-size:12px;color:var(--text3);margin-top:3px}
  .app-wrap{max-width:1400px;margin:0 auto;padding:20px 24px;display:flex;gap:20px;min-height:calc(100vh - 52px)}
  .sidebar{width:220px;min-width:220px;display:flex;flex-direction:column;gap:12px}
  .sidebar-card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
  .sidebar-nav{padding:8px}
  .nav-btn{width:100%;display:block;padding:9px 14px;border:none;border-radius:8px;background:transparent;color:var(--text3);font-size:14px;font-weight:500;cursor:pointer;font-family:var(--sans);text-align:left;transition:all .15s;margin-bottom:2px}
  .nav-btn:hover{color:var(--text);background:var(--bg)}
  .nav-btn.active{color:var(--text);background:var(--bg);font-weight:600}
  .sidebar.ps44 .nav-btn.active{color:var(--accent2)}
  .emp-list{padding:8px}
  .emp-list-label{font-size:11px;font-weight:600;color:var(--text4);letter-spacing:.06em;text-transform:uppercase;margin-bottom:8px;padding:0 10px}
  .emp-btn{width:100%;display:flex;align-items:center;gap:12px;padding:9px 10px;border:none;border-radius:8px;background:transparent;cursor:pointer;text-align:left;transition:all .15s;margin-bottom:2px}
  .emp-btn:hover{background:var(--bg)}
  .emp-btn.active{background:var(--bg)}
  .emp-idx{width:24px;height:24px;font-size:11px;font-family:var(--mono);color:var(--text4);text-align:center;line-height:24px;border-radius:6px;background:var(--bg);flex-shrink:0}
  .emp-btn.active .emp-idx{color:#fff;background:var(--accent);font-weight:600}
  .sidebar.ps44 .emp-btn.active .emp-idx{background:var(--accent2)}
  .emp-info{flex:1;min-width:0}
  .emp-name-text{font-size:14px;font-weight:400;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .emp-btn.active .emp-name-text{font-weight:600;color:var(--text)}
  .emp-hrs{font-size:12px;color:var(--text4);font-family:var(--mono);margin-top:1px}
  .emp-btn.active .emp-hrs{color:var(--text3)}
  .main{flex:1;min-width:0}
  .main-card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:24px;overflow-x:auto}
  .emp-header{display:flex;align-items:baseline;justify-content:space-between;margin-bottom:20px;padding-bottom:16px;border-bottom:2px solid var(--text)}
  .emp-header-left{display:flex;align-items:baseline;gap:14px}
  .emp-header-name{font-size:22px;font-weight:600;color:var(--text);letter-spacing:-.02em}
  .emp-header-meta{font-size:13px;color:var(--text3)}
  .emp-header-total{display:flex;align-items:baseline;gap:6px}
  .emp-total-num{font-size:28px;font-weight:300;color:var(--text);font-family:var(--mono);letter-spacing:-.02em}
  .emp-total-unit{font-size:13px;color:var(--text3)}
  .table-wrap{overflow-x:auto;margin:0 -4px}
  table{width:100%;border-collapse:collapse}
  .cat-row th{padding:4px 0;font-size:11px;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:var(--text3);text-align:center;border-bottom:1px solid var(--border);height:28px;vertical-align:bottom}
  .col-row th{padding:6px 0;font-size:12px;font-weight:700;font-family:var(--mono);text-align:center;color:var(--text2);border-bottom:1px solid var(--border)}
  .sub-row th{padding:4px 0;font-size:11px;font-weight:500;text-align:center;color:var(--text4);border-bottom:2px solid var(--text);font-family:var(--mono)}
  .sub-row .th-date{text-align:left;padding-left:4px}
  .sub-row .th-day{width:36px}
  .code-dropdown{position:relative}
  .code-dropdown-btn{width:100%;height:26px;border:none;border-bottom:1px solid var(--border);background:transparent;color:var(--text4);font-size:11px;font-family:var(--mono);cursor:pointer;text-align:center;padding:0 4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;transition:all .15s;border-radius:4px 4px 0 0}
  .code-dropdown-btn.has-value{color:var(--text2);font-weight:600}
  .code-dropdown-btn:hover{background:var(--bg);border-bottom-color:var(--text3)}
  .code-dropdown-panel{position:absolute;top:30px;left:50%;transform:translateX(-50%);z-index:1000;width:280px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow2);display:none;overflow:hidden}
  .code-dropdown-panel.open{display:block}
  .code-search-wrap{padding:8px;border-bottom:1px solid var(--border)}
  .code-search{width:100%;border:1px solid var(--border);border-radius:8px;padding:7px 12px;font-size:13px;outline:none;font-family:var(--sans);background:var(--bg)}
  .code-search:focus{border-color:var(--accent2);box-shadow:0 0 0 3px rgba(0,113,227,.15)}
  .code-list{max-height:220px;overflow-y:auto}
  .code-item{padding:8px 12px;font-size:13px;cursor:pointer;display:flex;gap:10px;align-items:center;border-bottom:1px solid var(--border)}
  .code-item:hover{background:var(--bg)}
  .code-item-code{font-family:var(--mono);font-weight:700;font-size:11px;color:var(--accent);min-width:48px}
  .code-item-desc{color:var(--text2)}
  .code-clear{color:var(--text3);padding:8px 12px;font-size:13px;cursor:pointer;border-bottom:1px solid var(--border)}
  .code-clear:hover{background:var(--bg);color:var(--text)}
  .data-row{border-bottom:1px solid var(--border)}
  .data-row:hover{background:rgba(0,113,227,.02)}
  .data-row.weekend{opacity:.3}
  .data-row .c-date{padding:2px 4px;font-family:var(--mono);font-size:13px;color:var(--text2);font-weight:500;white-space:nowrap;height:38px;vertical-align:middle}
  .data-row .c-day{padding:0 6px;text-align:center;font-size:12px;color:var(--text4);font-family:var(--mono);vertical-align:middle}
  .data-row .c-input{padding:0 1px;vertical-align:middle}
  .cell-input{width:100%;height:38px;border:none;background:transparent;text-align:center;font-size:14px;font-family:var(--mono);font-weight:400;color:var(--text4);outline:none;transition:all .15s;padding:0;border-radius:4px}
  .cell-input::placeholder{color:var(--border)}
  .cell-input:focus{background:rgba(0,113,227,.04);color:var(--text);box-shadow:inset 0 -2px 0 var(--accent2)}
  .cell-input.has-value{font-weight:600;color:var(--text)}
  .data-row .c-total{padding:0 8px;text-align:center;font-family:var(--mono);font-size:14px;vertical-align:middle}
  .c-total.has-val{font-weight:700;color:var(--text)}
  .c-total.no-val{color:var(--border)}
  .totals-row{border-top:2px solid var(--text)}
  .totals-row td{padding:12px 0;text-align:center;font-family:var(--mono);font-weight:600;font-size:14px;color:var(--text2)}
  .totals-row .t-label{text-align:left;padding-left:4px;font-family:var(--sans);font-size:12px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--text3)}
  .totals-row .t-no-val{color:var(--border)}
  .totals-row .t-grand{font-weight:700;color:var(--text);font-size:15px}
  .page-title{font-size:22px;font-weight:600;color:var(--text);margin-bottom:4px;letter-spacing:-.02em}
  .page-desc{font-size:14px;color:var(--text3);margin-bottom:20px}
  .search-input{width:100%;border:1px solid var(--border);border-radius:10px;padding:10px 16px;font-size:15px;margin-bottom:24px;outline:none;font-family:var(--sans);background:var(--bg);color:var(--text)}
  .search-input::placeholder{color:var(--text4)}
  .search-input:focus{border-color:var(--accent2);box-shadow:0 0 0 3px rgba(0,113,227,.15)}
  .codes-cat-label{font-size:11px;font-weight:700;color:var(--text4);letter-spacing:.08em;text-transform:uppercase;margin-bottom:8px;margin-top:24px}
  .codes-cat-label:first-of-type{margin-top:0}
  .code-ref-item{display:flex;align-items:center;gap:14px;padding:8px 0;border-bottom:1px solid var(--border)}
  .code-ref-badge{font-family:var(--mono);font-size:12px;font-weight:700;color:var(--accent);min-width:56px}
  .code-ref-desc{font-size:14px;color:var(--text2)}
  .settings-card{padding:20px 0;border-bottom:1px solid var(--border)}
  .settings-label{display:block;font-size:11px;font-weight:700;color:var(--text4);letter-spacing:.08em;text-transform:uppercase;margin-bottom:8px}
  .settings-input{border:1px solid var(--border);border-radius:8px;padding:8px 12px;font-size:15px;font-family:var(--mono);background:var(--bg);outline:none;color:var(--text);width:220px}
  .settings-input:focus{border-color:var(--accent2)}
  .settings-hint{font-size:13px;color:var(--text4);margin-top:6px}
  .settings-static{font-size:16px;color:var(--text2);padding:4px 0}
  .settings-instructions{font-size:14px;color:var(--text3);line-height:2}
</style>
</head>
<body>
<div class="topbar">
  <div class="topbar-left">
    <div class="topbar-mark" id="topbarMark"></div>
    <span class="topbar-title" id="topbarTitle">Payroll Application</span>
    <span class="topbar-district">Dist. 31</span>
    <div class="school-tabs" id="schoolTabs">
      <button class="school-tab active" data-school="portrichmond">Port Richmond</button>
      <button class="school-tab" data-school="ps44">PS 44</button>
    </div>
  </div>
  <div class="topbar-right">
    <span class="topbar-label">Period ending</span>
    <input type="date" class="topbar-date" id="payPeriodEnd" value="2026-01-27">
    <div class="export-wrap">
      <button class="export-btn" id="exportBtn">Export PDF</button>
      <div class="export-menu" id="exportMenu">
        <button class="export-menu-item" id="exportCurrent">
          <span class="em-label">Current Employee</span>
          <span class="em-desc">Export selected timesheet only</span>
        </button>
        <button class="export-menu-item" id="exportAll">
          <span class="em-label">All Employees</span>
          <span class="em-desc">Export all timesheets for current school</span>
        </button>
      </div>
    </div>
  </div>
</div>
<div class="app-wrap">
  <div class="sidebar" id="sidebarEl">
    <div class="sidebar-card"><div class="sidebar-nav" id="sidebarNav"></div></div>
    <div class="sidebar-card" id="empListCard"><div class="emp-list" id="empList"></div></div>
  </div>
  <div class="main"><div class="main-card" id="mainContent"></div></div>
</div>
<script>
var CODES=[{c:"I2JI3",d:"Overtime Lunch - SLH"},{c:"I2JI4",d:"Overtime Lunch - Sr. SLH"},{c:"I2JI5",d:"Special Event - SLH"},{c:"I2JI6",d:"Special Event - Sr. SLH"},{c:"I2JI7",d:"Weekend OT - SLH"},{c:"I2JI8",d:"Weekend OT - Sr. SLH"},{c:"I2JI9",d:"Holiday OT - SLH"},{c:"I2JIA",d:"Holiday OT - Sr. SLH"},{c:"I2JIB",d:"Snack - SLH"},{c:"I2JIC",d:"Snack - Sr. SLH"},{c:"I2JID",d:"Supper - SLH"},{c:"I2JIE",d:"Supper - Sr. SLH"},{c:"I2JIF",d:"School Aide Breakfast Hrs"},{c:"I2JIG",d:"BIC - SLH"},{c:"I2JIH",d:"BIC - Sr. SLH"},{c:"600FL",d:"Family Leave All"},{c:"60A00",d:"Court Subpoena"},{c:"60B00",d:"Death in Family"},{c:"60B0T",d:"Death in Family Travel"},{c:"60B10",d:"Funeral Relative"},{c:"60B20",d:"Funeral Coworker"},{c:"60C00",d:"Graduation"},{c:"60C0T",d:"Graduation / Travel"},{c:"61A00",d:"Self Treated Lunch"},{c:"61AAF",d:"Self Treated Afterschool"},{c:"61ABR",d:"Self Treated Breakfast"},{c:"61B00",d:"Medical Lunch"},{c:"61B0F",d:"Family Leave Lunch"},{c:"61BAF",d:"Medical Afterschool"},{c:"61BAT",d:"Family Leave Afterschool"},{c:"61BBF",d:"Family Leave Breakfast"},{c:"61BBR",d:"Medical Breakfast"},{c:"61BWC",d:"Workers Comp Med Cert"},{c:"61HFL",d:"Holiday Float 4 Days"},{c:"62RAF",d:"Religious Afterschool"},{c:"62RBR",d:"Religious Breakfast"},{c:"62RLG",d:"Religious Lunch"},{c:"63A00",d:"Personal Day Lunch"},{c:"63AAF",d:"Personal Day Afterschool"},{c:"63ABR",d:"Personal Day Breakfast"},{c:"63ECS",d:"Cancer Screening"},{c:"64A00",d:"Jury Duty"},{c:"66B00",d:"Workers Comp Injury"},{c:"66BH0",d:"Workers Comp Hearing"},{c:"67A00",d:"Lateness"},{c:"68A00",d:"Transit Delay"}];
var SC=[{k:"pyreg",l:"PYREG"},{k:"pybrk",l:"PYBRK"},{k:"pyaft",l:"PYAFT"}];
var BC=[{k:"bulk1",l:"--"},{k:"bulk2",l:"--"},{k:"bulk3",l:"--"},{k:"bulk4",l:"--"}];
var AC=SC.concat(BC);
var SCHOOLS={portrichmond:{name:"Port Richmond",accent:"#d63c2f",emps:[{id:1,f:"Lahene",l:"Edwards",eis:"2245250"},{id:2,f:"Servette",l:"Liharevic",eis:"2715560"},{id:3,f:"Seham",l:"Said",eis:"2712067"},{id:4,f:"Akil",l:"Ibtissam",eis:"2730676"},{id:5,f:"Angelina",l:"Obermeyer",eis:"2723767"},{id:6,f:"Nancy",l:"Wesa",eis:"2744757"},{id:7,f:"Carlo",l:"Fleming",eis:"TBD"}]},ps44:{name:"PS 44",accent:"#0071e3",emps:[{id:101,f:"Pietra",l:"Vendra",eis:"2736062"},{id:102,f:"Michael",l:"Legair",eis:"2744810"},{id:103,f:"Cristina",l:"Picciurro",eis:"2727735"}]}};
var S={payEnd:"2026-01-27",sel:0,view:"timesheet",data:{},bc:{},school:"portrichmond"};
var pf=["2026-01-14","2026-01-15","2026-01-16","2026-01-19","2026-01-20","2026-01-21","2026-01-22","2026-01-23","2026-01-26","2026-01-27"];
for(var pi=0;pi<pf.length;pi++){S.data["1_"+pf[pi]+"_pyreg_hrs"]=7;}
function curSchool(){return SCHOOLS[S.school];}
function curEmps(){return curSchool().emps;}
function mkDates(e){var end=new Date(e+"T12:00:00"),r=[];for(var i=13;i>=0;i--){var d=new Date(end);d.setDate(d.getDate()-i);r.push(d);}return r;}
function fmt(d){return String(d.getMonth()+1).padStart(2,"0")+"/"+String(d.getDate()).padStart(2,"0")+"/"+d.getFullYear();}
function dn(d){return d.toLocaleDateString("en-US",{weekday:"short"});}
function dk(d){return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0");}
function gv(eid,k,col,f){return S.data[eid+"_"+k+"_"+col+"_"+f]||0;}
function sv(eid,k,col,f,v){var key=eid+"_"+k+"_"+col+"_"+f;if(!v||isNaN(v))delete S.data[key];else S.data[key]=v;render();}
function etot(emp){var d=mkDates(S.payEnd),h=0,m=0;for(var di=0;di<d.length;di++){var k=dk(d[di]);for(var ci=0;ci<AC.length;ci++){h+=gv(emp.id,k,AC[ci].k,"hrs");m+=gv(emp.id,k,AC[ci].k,"min");}}return{h:h+Math.floor(m/60),m:m%60};}
function ccat(code){if(code.indexOf("I2J")===0)return"Overtime / Special";if(code.indexOf("60")===0)return"Leave & Events";if(code.indexOf("61")===0)return"Medical";if(code.indexOf("62")===0)return"Religious";if(code.indexOf("63")===0)return"Personal";return"Administrative";}

function buildEmpPdfData(emp){
  var d=mkDates(S.payEnd),bulkLabels=[],colLabels=[];
  for(var bi=0;bi<BC.length;bi++)bulkLabels.push(S.bc[emp.id+"_"+bi]||"--");
  for(var si=0;si<SC.length;si++)colLabels.push(SC[si].l);
  for(var bi2=0;bi2<bulkLabels.length;bi2++)colLabels.push(bulkLabels[bi2]);
  var headRow=["Date","Day"];
  for(var ci=0;ci<colLabels.length;ci++){headRow.push(colLabels[ci]+" H");headRow.push(colLabels[ci]+" M");}
  headRow.push("Total H");headRow.push("Total M");
  var head=[headRow],body=[];
  for(var di=0;di<d.length;di++){
    var k=dk(d[di]),row=[fmt(d[di]),dn(d[di])],rh=0,rm=0;
    for(var ci2=0;ci2<AC.length;ci2++){var hv=gv(emp.id,k,AC[ci2].k,"hrs"),mv=gv(emp.id,k,AC[ci2].k,"min");rh+=hv;rm+=mv;row.push(hv||"");row.push(mv||"");}
    row.push((rh+Math.floor(rm/60))||"");row.push((rm%60)||"");body.push(row);
  }
  var totRow=["TOTALS",""];
  for(var ci3=0;ci3<AC.length;ci3++){var ch=0,cm=0;for(var di2=0;di2<d.length;di2++){ch+=gv(emp.id,dk(d[di2]),AC[ci3].k,"hrs");cm+=gv(emp.id,dk(d[di2]),AC[ci3].k,"min");}totRow.push(ch||"");totRow.push(cm||"");}
  var t=etot(emp);totRow.push(t.h);totRow.push(t.m||"");body.push(totRow);
  return{head:head,body:body,emp:emp,total:t};
}

function exportPdf(empIndices){
  try{
    var jsPDF=window.jspdf.jsPDF;
    var doc=new jsPDF({orientation:"landscape",unit:"pt",format:"letter"});
    var pageW=doc.internal.pageSize.getWidth(),pageH=doc.internal.pageSize.getHeight();
    var emps=curEmps(),schoolName=curSchool().name.toUpperCase()+" PAYROLL - DISTRICT 31";
    for(var pi=0;pi<empIndices.length;pi++){
      if(pi>0)doc.addPage("letter","landscape");
      var emp=emps[empIndices[pi]],result=buildEmpPdfData(emp);
      var head=result.head,body=result.body,total=result.total,margin=36,y=margin;
      doc.setFont("helvetica","bold");doc.setFontSize(8);doc.setTextColor(140);
      doc.text(schoolName,margin,y);
      doc.setFont("helvetica","normal");doc.setFontSize(8);
      doc.text("PAY PERIOD ENDING: "+fmt(mkDates(S.payEnd)[13]),pageW-margin,y,{align:"right"});
      y+=22;doc.setFont("helvetica","bold");doc.setFontSize(16);doc.setTextColor(30);
      doc.text(emp.f+" "+emp.l,margin,y);
      var totalStr=total.h+(total.m>0?":"+String(total.m).padStart(2,"0"):"")+(" hours");
      doc.setFont("helvetica","normal");doc.setFontSize(16);
      doc.text(totalStr,pageW-margin,y,{align:"right"});
      y+=14;doc.setFont("courier","normal");doc.setFontSize(9);doc.setTextColor(120);
      doc.text("EIS "+emp.eis,margin,y);y+=8;
      doc.setDrawColor(30);doc.setLineWidth(1);doc.line(margin,y,pageW-margin,y);y+=10;
      var closureBody=body,closurePi=pi,closureLen=empIndices.length;
      doc.autoTable({startY:y,head:head,body:body,margin:{left:margin,right:margin},
        styles:{font:"helvetica",fontSize:7,cellPadding:{top:4,bottom:4,left:3,right:3},textColor:[50,50,50],lineColor:[220,220,222],lineWidth:0.3,halign:"center",valign:"middle"},
        headStyles:{fillColor:[245,245,247],textColor:[30,30,31],fontStyle:"bold",fontSize:6.5,halign:"center"},
        columnStyles:{0:{halign:"left",cellWidth:62,fontStyle:"bold"},1:{halign:"center",cellWidth:30}},
        bodyStyles:{minCellHeight:16},alternateRowStyles:{fillColor:[250,250,252]},
        didParseCell:function(data){
          if(data.row.index===closureBody.length-1){data.cell.styles.fontStyle="bold";data.cell.styles.fillColor=[240,240,242];data.cell.styles.textColor=[30,30,31];data.cell.styles.fontSize=7.5;}
          var rd=closureBody[data.row.index];
          if(rd&&(rd[1]==="Sat"||rd[1]==="Sun")&&data.row.index<closureBody.length-1){data.cell.styles.textColor=[190,190,195];}
          if(data.cell.raw===""&&data.section==="body"){data.cell.styles.textColor=[210,210,215];}
        },
        didDrawPage:function(data){
          doc.setFont("helvetica","normal");doc.setFontSize(7);doc.setTextColor(160);
          doc.text("Generated "+new Date().toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"}),margin,pageH-20);
          doc.text("Page "+(closurePi+1)+" of "+closureLen,pageW-margin,pageH-20,{align:"right"});
        }
      });
    }
    var dateStr=S.payEnd.replace(/-/g,""),label=empIndices.length===1?emps[empIndices[0]].l+"_"+emps[empIndices[0]].f:"All_Employees";
    var prefix=S.school==="ps44"?"PS44":"PortRichmond";
    doc.save(prefix+"_Payroll_"+label+"_"+dateStr+".pdf");
  }catch(err){alert("PDF Export Error: "+err.message);}
}

document.getElementById("exportBtn").addEventListener("click",function(e){e.stopPropagation();document.getElementById("exportMenu").classList.toggle("open");});
document.getElementById("exportCurrent").addEventListener("click",function(){document.getElementById("exportMenu").classList.remove("open");exportPdf([S.sel]);});
document.getElementById("exportAll").addEventListener("click",function(){document.getElementById("exportMenu").classList.remove("open");var idx=[];for(var i=0;i<curEmps().length;i++)idx.push(i);exportPdf(idx);});
document.addEventListener("click",function(e){if(!e.target.closest(".export-wrap"))document.getElementById("exportMenu").classList.remove("open");});
document.getElementById("schoolTabs").addEventListener("click",function(e){var tab=e.target.closest(".school-tab");if(!tab)return;S.school=tab.getAttribute("data-school");S.sel=0;S.view="timesheet";render();});

function render(){
  var school=curSchool(),emps=curEmps();
  document.getElementById("topbarMark").style.background=school.accent;
  var tabs=document.querySelectorAll(".school-tab");
  for(var ti=0;ti<tabs.length;ti++){tabs[ti].className="school-tab";if(tabs[ti].getAttribute("data-school")===S.school){tabs[ti].className="school-tab active";if(S.school==="ps44")tabs[ti].className="school-tab active ps44-active";}}
  document.getElementById("sidebarEl").className=S.school==="ps44"?"sidebar ps44":"sidebar";
  var navHtml='<button class="nav-btn '+(S.view==="timesheet"?"active":"")+'" data-view="timesheet">Timesheets</button>';
  navHtml+='<button class="nav-btn '+(S.view==="codes"?"active":"")+'" data-view="codes">Codes Reference</button>';
  navHtml+='<button class="nav-btn '+(S.view==="settings"?"active":"")+'" data-view="settings">Settings</button>';
  document.getElementById("sidebarNav").innerHTML=navHtml;
  document.getElementById("empListCard").style.display=S.view==="timesheet"?"block":"none";
  document.getElementById("payPeriodEnd").value=S.payEnd;
  var el=document.getElementById("empList"),h='<div class="emp-list-label">Employees</div>';
  for(var i=0;i<emps.length;i++){var t=etot(emps[i]),hrs=t.h>0?t.h+"h"+(t.m>0?" "+t.m+"m":""):"--";
    h+='<button class="emp-btn '+(S.sel===i?"active":"")+'" data-idx="'+i+'"><span class="emp-idx">'+String(i+1).padStart(2,"0")+'</span><div class="emp-info"><div class="emp-name-text">'+emps[i].l+', '+emps[i].f+'</div><div class="emp-hrs">'+hrs+'</div></div></button>';}
  el.innerHTML=h;
  var mc=document.getElementById("mainContent");
  if(S.view==="timesheet")mc.innerHTML=rTS();else if(S.view==="codes")mc.innerHTML=rCodes();else mc.innerHTML=rSettings();
  bindEvents();
}

function rTS(){
  var emps=curEmps(),emp=emps[S.sel],d=mkDates(S.payEnd),t=etot(emp);
  var tStr=t.h+(t.m>0?":"+String(t.m).padStart(2,"0"):""),schoolLabel=curSchool().name;
  var h='<div class="emp-header"><div class="emp-header-left"><span class="emp-header-name">'+emp.f+' '+emp.l+'</span><span class="emp-header-meta">EIS '+emp.eis+' &middot; '+schoolLabel+' &middot; Dist. 31</span></div><div class="emp-header-total"><span class="emp-total-num">'+tStr+'</span><span class="emp-total-unit">hours</span></div></div><div class="table-wrap"><table>';
  h+='<tr class="cat-row"><th colspan="2"></th><th colspan="'+(SC.length*2)+'">Scheduled</th><th colspan="'+(BC.length*2)+'">Unscheduled / Bulk</th><th colspan="2"></th></tr>';
  h+='<tr class="col-row"><th colspan="2"></th>';
  for(var si=0;si<SC.length;si++)h+='<th colspan="2">'+SC[si].l+'</th>';
  for(var bi=0;bi<BC.length;bi++){var val=S.bc[emp.id+"_"+bi]||"";h+='<th colspan="2" style="padding:2px 4px"><div class="code-dropdown" data-emp="'+emp.id+'" data-bidx="'+bi+'"><button class="code-dropdown-btn '+(val?"has-value":"")+'">'+(val||"Code")+'</button><div class="code-dropdown-panel" id="cdp_'+emp.id+'_'+bi+'"><div class="code-search-wrap"><input class="code-search" placeholder="Search..." data-emp="'+emp.id+'" data-bidx="'+bi+'"></div><div class="code-list" id="cdl_'+emp.id+'_'+bi+'"></div></div></div></th>';}
  h+='<th colspan="2">Total</th></tr><tr class="sub-row"><th class="th-date">Date</th><th class="th-day">Day</th>';
  for(var ci=0;ci<AC.length;ci++)h+='<th>H</th><th>M</th>';
  h+='<th>H</th><th>M</th></tr>';
  for(var di=0;di<d.length;di++){var k=dk(d[di]),day=dn(d[di]),wk=d[di].getDay()===0||d[di].getDay()===6,rh=0,rm=0;
    for(var ci2=0;ci2<AC.length;ci2++){rh+=gv(emp.id,k,AC[ci2].k,"hrs");rm+=gv(emp.id,k,AC[ci2].k,"min");}
    var nh=rh+Math.floor(rm/60),nm=rm%60;
    h+='<tr class="data-row '+(wk?"weekend":"")+'"><td class="c-date">'+fmt(d[di])+'</td><td class="c-day">'+day+'</td>';
    for(var ci3=0;ci3<AC.length;ci3++){var hv=gv(emp.id,k,AC[ci3].k,"hrs"),mv=gv(emp.id,k,AC[ci3].k,"min");
      h+='<td class="c-input"><input class="cell-input '+(hv?"has-value":"")+'" type="number" min="0" max="24" placeholder="&middot;" value="'+(hv||"")+'" data-emp="'+emp.id+'" data-dk="'+k+'" data-col="'+AC[ci3].k+'" data-field="hrs"></td>';
      h+='<td class="c-input"><input class="cell-input '+(mv?"has-value":"")+'" type="number" min="0" max="59" placeholder="&middot;" value="'+(mv||"")+'" data-emp="'+emp.id+'" data-dk="'+k+'" data-col="'+AC[ci3].k+'" data-field="min"></td>';}
    h+='<td class="c-total '+(nh?"has-val":"no-val")+'">'+(nh||"&middot;")+'</td><td class="c-total '+(nm?"has-val":"no-val")+'">'+(nm||"&middot;")+'</td></tr>';}
  h+='<tr class="totals-row"><td class="t-label" colspan="2">Totals</td>';
  for(var ci4=0;ci4<AC.length;ci4++){var ch2=0,cm2=0;for(var di2=0;di2<d.length;di2++){ch2+=gv(emp.id,dk(d[di2]),AC[ci4].k,"hrs");cm2+=gv(emp.id,dk(d[di2]),AC[ci4].k,"min");}
    h+='<td>'+(ch2||"&middot;")+'</td><td class="'+(cm2?"":"t-no-val")+'">'+(cm2||"&middot;")+'</td>';}
  h+='<td class="t-grand">'+t.h+'</td><td class="'+(t.m?"t-grand":"t-no-val")+'">'+(t.m||"&middot;")+'</td></tr></table></div>';
  return h;
}

function rCodes(){
  var cats={};for(var i=0;i<CODES.length;i++){var cat=ccat(CODES[i].c);if(!cats[cat])cats[cat]=[];cats[cat].push(CODES[i]);}
  var h='<div style="max-width:560px"><div class="page-title">Codes Reference</div><div class="page-desc">Payroll codes for bulk entry, overtime, leave, and administrative use.</div><input class="search-input" id="codeSearchInput" type="text" placeholder="Search codes...">';
  var catKeys=Object.keys(cats);
  for(var ci=0;ci<catKeys.length;ci++){h+='<div class="codes-cat-label" data-cat="'+catKeys[ci]+'">'+catKeys[ci]+'</div>';
    for(var j=0;j<cats[catKeys[ci]].length;j++){var c=cats[catKeys[ci]][j];h+='<div class="code-ref-item" data-code="'+c.c+'" data-desc="'+c.d+'"><span class="code-ref-badge">'+c.c+'</span><span class="code-ref-desc">'+c.d+'</span></div>';}}
  return h+'</div>';
}

function rSettings(){
  return'<div style="max-width:440px"><div class="page-title">Settings</div><div class="page-desc">Pay period and district configuration.</div><div class="settings-card"><label class="settings-label">Pay Period Ending</label><input class="settings-input" type="date" id="settingsPayEnd" value="'+S.payEnd+'"><div class="settings-hint">All timesheets auto-update with 14 days ending on this date.</div></div><div class="settings-card"><label class="settings-label">Current School</label><div class="settings-static">'+curSchool().name+'</div></div><div class="settings-card"><label class="settings-label">District</label><div class="settings-static">31</div></div><div class="settings-card"><label class="settings-label">Instructions</label><div class="settings-instructions">1. Select a school tab at the top.<br>2. Set the pay period ending date.<br>3. Select an employee from the sidebar.<br>4. Enter hours and minutes in the grid.<br>5. Use code dropdowns for bulk/unscheduled entries.<br>6. Totals calculate automatically.</div></div></div>';
}

function bindEvents(){
  var inputs=document.querySelectorAll(".cell-input");
  for(var i=0;i<inputs.length;i++){inputs[i].addEventListener("change",function(e){var emp=e.target.getAttribute("data-emp"),dk2=e.target.getAttribute("data-dk"),col=e.target.getAttribute("data-col"),field=e.target.getAttribute("data-field");sv(parseInt(emp,10),dk2,col,field,e.target.value===""?null:parseInt(e.target.value,10));});}
  var cdBtns=document.querySelectorAll(".code-dropdown-btn");
  for(var j=0;j<cdBtns.length;j++){cdBtns[j].addEventListener("click",function(e){var w=e.target.closest(".code-dropdown"),eid=w.getAttribute("data-emp"),bi=w.getAttribute("data-bidx"),p=document.getElementById("cdp_"+eid+"_"+bi);var panels=document.querySelectorAll(".code-dropdown-panel");for(var k=0;k<panels.length;k++){if(panels[k]!==p)panels[k].classList.remove("open");}p.classList.toggle("open");if(p.classList.contains("open")){var si=p.querySelector(".code-search");si.value="";si.focus();fillCL(eid,bi,"");}});}
  var csInputs=document.querySelectorAll(".code-search");
  for(var k=0;k<csInputs.length;k++){csInputs[k].addEventListener("input",function(e){fillCL(e.target.getAttribute("data-emp"),e.target.getAttribute("data-bidx"),e.target.value);});}
  var sd=document.getElementById("settingsPayEnd");if(sd)sd.addEventListener("change",function(e){S.payEnd=e.target.value;render();});
  var cs=document.getElementById("codeSearchInput");
  if(cs){cs.addEventListener("input",function(e){var q=e.target.value.toLowerCase();var items=document.querySelectorAll(".code-ref-item");for(var m=0;m<items.length;m++){var show=items[m].getAttribute("data-code").toLowerCase().indexOf(q)>=0||items[m].getAttribute("data-desc").toLowerCase().indexOf(q)>=0;items[m].style.display=show?"flex":"none";}var labels=document.querySelectorAll(".codes-cat-label");for(var n=0;n<labels.length;n++){var nx=labels[n].nextElementSibling,any=false;while(nx&&!nx.classList.contains("codes-cat-label")){if(nx.style.display!=="none")any=true;nx=nx.nextElementSibling;}labels[n].style.display=any?"block":"none";}});}
  var navBtns=document.querySelectorAll(".nav-btn");
  for(var nb=0;nb<navBtns.length;nb++){navBtns[nb].addEventListener("click",function(e){S.view=e.target.getAttribute("data-view");render();});}
  var empBtns=document.querySelectorAll(".emp-btn");
  for(var eb=0;eb<empBtns.length;eb++){empBtns[eb].addEventListener("click",function(e){var btn=e.target.closest(".emp-btn");S.sel=parseInt(btn.getAttribute("data-idx"),10);render();});}
}

function fillCL(eid,bi,search){
  var el=document.getElementById("cdl_"+eid+"_"+bi),q=search.toLowerCase(),filt=[];
  for(var i=0;i<CODES.length;i++){if(CODES[i].c.toLowerCase().indexOf(q)>=0||CODES[i].d.toLowerCase().indexOf(q)>=0)filt.push(CODES[i]);}
  var h='<div class="code-clear" data-emp="'+eid+'" data-bidx="'+bi+'" data-code="">Clear</div>';
  for(var j=0;j<filt.length;j++){h+='<div class="code-item" data-emp="'+eid+'" data-bidx="'+bi+'" data-code="'+filt[j].c+'"><span class="code-item-code">'+filt[j].c+'</span><span class="code-item-desc">'+filt[j].d+'</span></div>';}
  el.innerHTML=h;
  var items=el.querySelectorAll(".code-item,.code-clear");
  for(var k=0;k<items.length;k++){items[k].addEventListener("click",function(e){var t=e.target.closest("[data-code]");S.bc[t.getAttribute("data-emp")+"_"+t.getAttribute("data-bidx")]=t.getAttribute("data-code");var panels=document.querySelectorAll(".code-dropdown-panel");for(var p=0;p<panels.length;p++)panels[p].classList.remove("open");render();});}
}

document.addEventListener("click",function(e){if(!e.target.closest(".code-dropdown")){var panels=document.querySelectorAll(".code-dropdown-panel");for(var i=0;i<panels.length;i++)panels[i].classList.remove("open");}});
document.getElementById("payPeriodEnd").addEventListener("change",function(e){S.payEnd=e.target.value;render();});
render();
</script>
</body>
</html>
